<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 åˆ†å¸ƒå¼æ—¥è®°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <style>
        /* CSS æ ·å¼ï¼šæ·±è‰²ç°ä»£æç®€é£ */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary-color: #bb86fc;
            --text-color: #e0e0e0;
            --secondary-text: #a0a0a0;
            --border-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 { margin: 0; font-size: 1.5rem; }

        button {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover { opacity: 0.9; }
        button:disabled { background-color: #555; cursor: not-allowed; }

        .section-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* å†™æ—¥è®°åŒºåŸŸ */
        textarea {
            width: 100%;
            background-color: #2c2c2c;
            border: 1px solid var(--border-color);
            color: white;
            padding: 10px;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            box-sizing: border-box; /* ç¡®ä¿ padding ä¸æ’‘å¤§å®½åº¦ */
            margin-bottom: 10px;
            font-family: inherit;
        }

        textarea:focus { outline: 2px solid var(--primary-color); }

        /* æ—¥è®°åˆ—è¡¨åŒºåŸŸ */
        .diary-list { display: flex; flex-direction: column; gap: 15px; }
        
        .diary-item {
            background-color: #2c2c2c;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .diary-content { font-size: 1rem; margin-bottom: 8px; line-height: 1.5; }
        .diary-author { font-size: 0.8rem; color: var(--secondary-text); word-break: break-all; }

        #walletAddress { font-family: monospace; color: var(--secondary-text); }
        .status-msg { font-size: 0.9rem; margin-top: 5px; color: var(--primary-color); min-height: 20px;}
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Web3 Diary</h1>
            <div id="walletInfo">
                <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
                <span id="walletAddress" style="display: none;"></span>
            </div>
        </header>

        <div class="section-card">
            <h3>âœï¸ å†™æ—¥è®°</h3>
            <textarea id="diaryInput" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ(å†™å…¥åŒºå—é“¾æ°¸ä¹…ä¿å­˜)"></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button id="writeBtn" onclick="writeDiary()" disabled>æäº¤ä¸Šé“¾</button>
                <div id="writeStatus" class="status-msg"></div>
            </div>
        </div>

        <div class="section-card">
            <h3>ğŸ“– æ—¥è®°åˆ—è¡¨</h3>
            <div id="diaryList" class="diary-list">
                <div style="text-align: center; color: #777;">è¯·å…ˆè¿æ¥é’±åŒ…ä»¥è¯»å–æ•°æ®...</div>
            </div>
        </div>
    </div>

    <script>
        // 1. é…ç½®åˆçº¦ä¿¡æ¯
        const CONTRACT_ADDRESS = "0x117500dE17DE2700A7bEAC2f27e3B056C96c7E24";
        const ABI = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[],"name":"clearDiary","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"readDiary","outputs":[{"components":[{"internalType":"string","name":"content","type":"string"},{"internalType":"address","name":"author","type":"address"}],"internalType":"struct DiaryContract.DiaryEntry[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"_content","type":"string"}],"name":"writeDiary","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        // å…¨å±€å˜é‡
        let provider;
        let signer;
        let contract;

        // 2. è¿æ¥é’±åŒ…åŠŸèƒ½
        async function connectWallet() {
            if (!window.ethereum) {
                alert("è¯·å®‰è£… MetaMask é’±åŒ…ï¼");
                return;
            }

            try {
                // åˆå§‹åŒ– Provider (Ethers v6 å†™æ³•)
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // è¯·æ±‚ç”¨æˆ·æˆæƒ
                await provider.send("eth_requestAccounts", []);
                
                // è·å– Signer (ç­¾åè€…ï¼Œç”¨äºå‘é€äº¤æ˜“)
                signer = await provider.getSigner();
                const address = await signer.getAddress();

                // æ£€æŸ¥å¹¶åˆ‡æ¢åˆ° Sepolia ç½‘ç»œ
                await checkNetwork();

                // åˆå§‹åŒ–åˆçº¦å®ä¾‹
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                // æ›´æ–° UI
                document.getElementById("connectBtn").style.display = "none";
                const addrDisplay = document.getElementById("walletAddress");
                addrDisplay.innerText = address.slice(0,6) + "..." + address.slice(-4);
                addrDisplay.style.display = "block";
                document.getElementById("writeBtn").disabled = false;

                // è‡ªåŠ¨åŠ è½½æ—¥è®°
                loadDiaries();

            } catch (error) {
                console.error("è¿æ¥å¤±è´¥:", error);
                alert("è¿æ¥é’±åŒ…å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°");
            }
        }

        // è¾…åŠ©ï¼šç¡®ä¿ç”¨æˆ·åœ¨ Sepolia æµ‹è¯•ç½‘
        async function checkNetwork() {
            const network = await provider.getNetwork();
            // Sepolia Chain ID æ˜¯ 11155111 (åå…­è¿›åˆ¶ 0xaa36a7)
            if (network.chainId !== 11155111n) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0xaa36a7' }],
                    });
                } catch (err) {
                    alert("è¯·åœ¨ MetaMask ä¸­åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘ï¼");
                }
            }
        }

        // 3. è¯»å–æ—¥è®°åŠŸèƒ½
        async function loadDiaries() {
            const listDiv = document.getElementById("diaryList");
            listDiv.innerHTML = '<div style="text-align: center; color: #777;">æ­£åœ¨ä»åŒºå—é“¾è¯»å–æ•°æ®...</div>';

            try {
                // è°ƒç”¨åˆçº¦ readDiary å‡½æ•°
                const diaries = await contract.readDiary();
                
                // æ¸…ç©ºåˆ—è¡¨
                listDiv.innerHTML = "";

                if (diaries.length === 0) {
                    listDiv.innerHTML = '<div style="text-align: center; color: #777;">æš‚æ— æ—¥è®°ï¼Œå¿«æ¥å†™ç¬¬ä¸€ç¯‡å§ï¼</div>';
                    return;
                }

                // éå†æ•°æ®å¹¶æ¸²æŸ“ (å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                // Ethers v6 è¿”å›çš„æ˜¯ Proxy å¯¹è±¡ï¼Œå¯ä»¥åƒæ•°ç»„ä¸€æ ·éå†
                [...diaries].reverse().forEach(entry => {
                    const content = entry.content; // å¯¹åº”ç»“æ„ä½“ content
                    const author = entry.author;   // å¯¹åº”ç»“æ„ä½“ author

                    const itemHtml = `
                        <div class="diary-item">
                            <div class="diary-content">${escapeHtml(content)}</div>
                            <div class="diary-author">Author: ${author}</div>
                        </div>
                    `;
                    listDiv.innerHTML += itemHtml;
                });

            } catch (error) {
                console.error("è¯»å–å¤±è´¥:", error);
                listDiv.innerHTML = '<div style="color: red; text-align: center;">è¯»å–å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²è¿æ¥ Sepolia ç½‘ç»œ</div>';
            }
        }

        // 4. å†™æ—¥è®°åŠŸèƒ½
        async function writeDiary() {
            const input = document.getElementById("diaryInput");
            const content = input.value.trim();
            const statusDiv = document.getElementById("writeStatus");
            const btn = document.getElementById("writeBtn");

            if (!content) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");

            try {
                btn.disabled = true;
                statusDiv.innerText = "â³ æ­£åœ¨è¯·æ±‚é’±åŒ…ç­¾å...";

                // è°ƒç”¨åˆçº¦ writeDiary å‡½æ•°
                const tx = await contract.writeDiary(content);
                
                statusDiv.innerText = "ğŸš€ äº¤æ˜“å·²å‘é€ï¼Œç­‰å¾…åŒºå—ç¡®è®¤...";
                
                // ç­‰å¾…äº¤æ˜“ä¸Šé“¾ç¡®è®¤
                await tx.wait();

                statusDiv.innerText = "âœ… å†™å…¥æˆåŠŸï¼";
                input.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
                
                // é‡æ–°åŠ è½½åˆ—è¡¨
                setTimeout(() => {
                    statusDiv.innerText = "";
                    loadDiaries();
                }, 2000);

            } catch (error) {
                console.error("å†™å…¥å¤±è´¥:", error);
                statusDiv.innerText = "âŒ å†™å…¥å¤±è´¥";
                if(error.code === 'ACTION_REJECTED') {
                    alert("ä½ æ‹’ç»äº†äº¤æ˜“ç­¾å");
                }
            } finally {
                btn.disabled = false;
            }
        }

        // ç®€å•çš„é˜² XSS å¤„ç†
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>